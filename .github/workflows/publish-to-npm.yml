name: publish-to-npm
run-name: ${{ github.actor }} is publishing to npm
on:
  workflow_dispatch:
    inputs:
      bump_level:
        description: type of version bump
        type: choice
        default: patch
        required: true
        options:
          - patch
          - minor
          - major
          - custom (use custom version)
      custom_bump_level:
        description: custom version (passed directly to npm version)
        type: string

jobs:
  validate-input:
    name: validate inputs
    runs-on: ubuntu-latest
    steps:
      - run: "echo 'type of version bump: ${{ inputs.bump_level }}' && echo 'custom version arguments: ${{ inputs.custom_bump_level }}'"
      - if: ${{ startsWith(inputs.bump_level, 'custom') && inputs.custom_bump_level == null }}
        run: "echo 'custom version indicated but no custom version arguments provided' && exit 1"
      - if: ${{ ! startsWith(inputs.bump_level, 'custom') && inputs.custom_bump_level != null }}
        run: "echo 'custom version arguments provided but version bump was not custom' && exit 1"
  build-and-publish:
    name: build and publish
    needs: [validate-input]
    uses: determined-ai/publish-to-npm-action/.github/workflows/publish-to-npm.yml@main
    with:
      bump_level: ${{ startsWith(inputs.bump_level, 'custom') && inputs.custom_bump_level || inputs.bump_level }}
    secrets:
      NPM_CLASSIC_TOKEN: ${{ secrets.NPM_CLASSIC_TOKEN }}
